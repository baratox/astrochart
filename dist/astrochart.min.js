
/*
 * -------------------------------------------------------
 * Project: AstroChart
 * Version: 0.1.0
 *
 * Author:  KpriKornius
 * Site:     
 * Contact: 
 *
 *
 * Copyright (c) 2016 KpriKornius
 * -------------------------------------------------------
 */

Snap.plugin(function(Snap,Element,Paper){"use strict";Element.prototype.get_orbit=function(angle,radius,cx,cy){var x=cx+radius*Math.cos(Snap.rad(angle)),y=cy+radius*Math.sin(Snap.rad(angle));return{x:x,y:y}},Element.prototype.orbit=function(angle,radius,cx,cy){var point=this.get_orbit(angle,radius,cx,cy),matrix=new Snap.Matrix;matrix.translate(point.x,point.y),this.transformOriginal(matrix)}}),Snap.plugin(function(Snap,Element,Paper){"use strict";Element.prototype.transformOriginal=function(t,append){if("undefined"==typeof t)this.data("original-transform",this.transform().localMatrix);else{append="undefined"!=typeof append?append:!1;var original=null!=this.data("original-transform")?this.data("original-transform").clone():null;original?t instanceof Snap.Matrix?append?this.transform(original.add(t)):this.transform(t.add(original)):append?(this.transform(original),this.transform(t)):(this.transform(t),this.transform(original)):this.transform(t)}}}),window.Astrochart=function(w,h,overridenSettings){"use strict";function _Astrochart(w,h,overridenSettings){overridenSettings&&(settings=$.extend(settings,overridenSettings)),snap=Snap(w,h),snap.attr({viewBox:"0 0 600 600",height:"100%",width:"100%"}),theme=new Astrochart.AstrochartTheme(snap,settings)}function ascendant(degrees){return void 0!==degrees?(theme.ascendant(degrees),now.ascendant=degrees,this):now.ascendant}function move(planets,degrees){return iterateIfCollection(planets,degrees,_move)}function _move(planet,degrees){return void 0===now.planets[planet]?!1:void 0!==degrees?(theme.astro(planet,degrees),now.planets[planet]=degrees,this):now.planets[planet]}function house(houses,degrees){var result=iterateIfCollection(houses,degrees,_house);return theme.invalidate(),result}function _house(house,degrees){return house="number"!=typeof house?parseInt(house):house,void 0===now.houses[house]?!1:void 0!==degrees?(theme.house(house,degrees),now.houses[house]=degrees,this):now.houses[house]}function aspect(aspects){for(var i in aspects){var aspect=aspects[i];theme.aspect(aspect.a,aspect.b,aspect.value,aspect.classes)}}function iterateIfCollection(argument,parameter,callback){if("object"==typeof argument){for(var i in argument)callback(i,argument[i]);return this}return"string"==typeof argument||"number"==typeof argument?callback(argument,parameter):void 0}var snap,theme,settings={"sprites-base-url":"/dist/image"},now={ascendant:0,houses:{1:0,2:30,3:60,4:90,5:120,6:150,7:180,8:210,9:240,10:270,11:300,12:330},planets:{sun:0,moon:0,mercury:0,venus:0,mars:0,jupiter:0,saturn:0,uranus:0,neptune:0,pluto:0}};return _Astrochart(void 0!==w?w:600,h,overridenSettings),{snap:snap,theme:theme,ascendant:ascendant,move:move,house:house,aspect:aspect}},Astrochart.AstrochartTheme=function(_svg,_settings){function _isAspectTarget(target){return settings["visible-astros"].indexOf(target)>=0?!0:target in settings.houses?!0:!1}var settings=jQuery.extend({"sprites-planet-size":108,center:{x:300,y:300},"astro-orbit":198,"aspect-orbit":164,"aspect-maximun-stroke":4,"visible-astros":["sun","moon","mercury","venus","mars","jupiter","saturn","uranus","neptune","pluto"],houses:{visibility:"hidden","house-1":{position:180,"text-position":90},"house-2":{position:210,"text-position":90},"house-3":{position:240,"text-position":90},"house-4":{position:270,"text-position":90},"house-5":{position:300,"text-position":90},"house-6":{position:330,"text-position":90},"house-7":{position:360,"text-position":90},"house-8":{position:390,"text-position":90},"house-9":{position:420,"text-position":90},"house-10":{position:450,"text-position":90},"house-11":{position:480,"text-position":90},"house-12":{position:510,"text-position":90}},"zodiac-rotation":105},_settings),absolute_zero=settings["zodiac-rotation"];Snap.load(settings["sprites-base-url"]+"/zodiac.svg",function(svg){_svg.append(svg);for(var house=1;12>=house;house++){var id="house-"+house,text=_svg.select("#"+id+"-text");text&&text.data("position",settings.houses[id]["text-position"]);var marker=_svg.select("#"+id);marker&&(marker.data("position",settings.houses[id].position),marker.data("text",text))}_svg.select("#houses").attr({visibility:settings.houses.visibility}),console.debug("Finished loading zodiac.svg.")}),Snap.load(settings["sprites-base-url"]+"/things.svg",function(svg){function loadSpaceObject(svg,name,animationDelay){console.log("Loading",name);var object=svg.select("g#"+name);object||(object=svg.select("g#planet").clone(),object.attr({id:name})),object.data("position",0),_svg.append(object);var scale=.37,half=scale*settings["sprites-planet-size"]/2,matrix=new Snap.Matrix;matrix.translate(-half,-half),matrix.scale(scale),object.transform(matrix),object.transformOriginal(),object.orbit(0,settings["astro-orbit"],settings.center.x,settings.center.y)}for(var i in settings["visible-astros"])loadSpaceObject(svg,settings["visible-astros"][i],1e4*Math.random()+3e3)});var _abs=function(zodiac){var absolute=zodiac-absolute_zero;return absolute},_round=function(number){"number"!=typeof number&&console.warn("Invalid number",number,typeof number);var rounded=number;return 0>number&&(rounded+=360),number>=360&&(rounded-=360),Number(rounded.toFixed(3))},_centerHouseText=function(house_number){var text=house(house_number).data("text");if(text){var next=12>house_number?house_number+1:1,center=_round((house(house_number).data("position")+house(next).data("position"))/2);6==house_number&&(center+=180);var rotation=_round(text.data("position")-center);console.log("Centering text for house",house_number,"to",center,"by",rotation,"was",text.data("position")),text.data("position",center);var matrix=new Snap.Matrix;return matrix.rotate(rotation,300,300),matrix.add(text.transform().localMatrix),text.transform(matrix),text}throw"No text for house "+house_number},invalidate=function(){for(var house=1;12>=house;house++)_centerHouseText(house)},ascendant=function(zodiac){var wheel=_svg.select("g#zodiac");if(wheel){if(void 0===zodiac)return wheel;if(zodiac=_round(zodiac),absolute_zero!=zodiac){var angleFrom=absolute_zero-settings["zodiac-rotation"],angleTo=zodiac-settings["zodiac-rotation"];console.debug("Rotating zodiac to",zodiac),Snap.animate(angleFrom,angleTo,function(value){wheel.transform("r"+value+",300,300")},800),wheel.data("rotation",angleTo),absolute_zero=zodiac}return wheel}throw"Zodiac does not exist"},house=function(house,zodiac){var element=_svg.select("#house-"+house);if(element){if(void 0===zodiac)return element;"hidden"===settings.houses.visibility&&(settings.houses.visibility="visible",_svg.select("#houses").attr({visibility:"visible"}));var absolute=_round(_abs(zodiac)+180),rotation=_round(element.data("position")-absolute);console.debug("Rotating house",house,"to",absolute,"(",rotation,"rotation ).");var matrix=new Snap.Matrix;return matrix.rotate(rotation,300,300),matrix.add(element.transform().localMatrix),element.transform(matrix),element.data("position",absolute),element}throw"House "+house+" does not exist"},astro=function(name,zodiac){var element=_svg.select("g#"+name);if(element){if(void 0===zodiac)return element;var angleFrom=element.data("position");return angleTo=_round(_abs(zodiac)+180),console.debug("Moving",name,"from",angleFrom,"to",angleTo),Snap.animate(angleFrom,angleTo,function(value){element.orbit(-value,settings["astro-orbit"],settings.center.x,settings.center.y)},400),element.data("position",angleTo),element}throw"Astro "+name+" does not exist"},aspect=function(a,b,value,classes){if(!_isAspectTarget(a))throw a+" is unknown";if(!_isAspectTarget(b))throw b+" is unknown";var astro_a=_svg.select("#"+a),astro_b=_svg.select("#"+b),point_a=_svg.get_orbit(-astro_a.data("position"),settings["aspect-orbit"],settings.center.x,settings.center.y),point_b=_svg.get_orbit(-astro_b.data("position"),settings["aspect-orbit"],settings.center.x,settings.center.y),id=b>a?"aspect-"+a+"-"+b:"aspect-"+b+"-"+a,line=_svg.select("#"+id);return line?line.attr({"class":classes,x1:point_a.x,y1:point_a.y,x2:point_b.x,y2:point_b.y,strokeWidth:value*settings["aspect-maximun-stroke"]}):(line=_svg.line(point_a.x,point_a.y,point_b.x,point_b.y),line.attr({id:id,"class":classes}),line.attr({stroke:"#777",strokeWidth:value*settings["aspect-maximun-stroke"]}),_svg.add(line)),line};return{ascendant:ascendant,astro:astro,house:house,aspect:aspect,invalidate:invalidate}};