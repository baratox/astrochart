
/*
 * -------------------------------------------------------
 * Project: AstroChart
 * Version: 0.1.0
 *
 * Author:  KpriKornius
 * Site:     
 * Contact: 
 *
 *
 * Copyright (c) 2016 KpriKornius
 * -------------------------------------------------------
 */

Snap.plugin(function(Snap,Element,Paper){"use strict";const PLANET_SIZE=108;Paper.prototype.createCircularOrbit=function(cx,cy,r){String.prototype.format||(String.prototype.format=function(){var str=this.toString();if(!arguments.length)return str;var args=typeof arguments[0],args="string"==args||"number"==args?arguments:arguments[0];for(var arg in args)str=str.replace(RegExp("\\{"+arg+"\\}","gi"),args[arg]);return str});var path=this.path("M {cx}, {cy} m -{r}, 0 a {r},{r} 0 1,0 {d},0 a {r},{r} 0 1,0 -{d},0".format({cx:cx,cy:cy,r:r,d:2*r}));return path.attr({id:"orbit",fill:"none"}),path},Element.prototype.orbit=function(orbit,degrees){var pathLength=orbit.getTotalLength(),point=orbit.getPointAtLength(degrees*pathLength/360),scale=.5,half=scale*PLANET_SIZE/2,matrix=new Snap.Matrix;matrix.translate(point.x,point.y),matrix.translate(-half,-half),matrix.scale(scale),this.transform(matrix)}}),window.Astrochart=function(w,h,overridenSettings){"use strict";function _Astrochart(w,h,overridenSettings){overridenSettings&&(settings=$.extend(settings,overridenSettings)),snap=Snap(w,h),snap.attr({viewBox:"0 0 600 600",height:"100%",width:"100%"}),theme=new Astrochart.AstrochartTheme(snap,settings)}function ascendant(degrees){return void 0!==degrees?(theme.ascendant(degrees),now.ascendant=degrees,this):now.ascendant}function move(planets,degrees){return iterateIfCollection(planets,degrees,_move)}function _move(planet,degrees){return void 0===now.planets[planet]?!1:void 0!==degrees?(theme.astro(planet,degrees),now.planets[planet]=degrees,this):now.planets[planet]}function house(houses,degrees){var result=iterateIfCollection(houses,degrees,_house);return theme.invalidate(),result}function _house(house,degrees){return void 0===now.houses[house]?!1:void 0!==degrees?(theme.house(house,degrees),now.houses[house]=degrees,this):now.houses[house]}function iterateIfCollection(argument,parameter,callback){if("object"==typeof argument){for(var i in argument)callback(i,argument[i]);return this}return"string"==typeof argument||"number"==typeof argument?callback(argument,parameter):void 0}var snap,theme,settings={"sprites-base-url":"/dist/image"},now={ascendant:0,houses:{1:0,2:30,3:60,4:90,5:120,6:150,7:180,8:210,9:240,10:270,11:300,12:330},planets:{sun:0,moon:0,mercury:0,venus:0,mars:0,jupiter:0,saturn:0,uranus:0,neptune:0,pluto:0}};return _Astrochart(void 0!==w?w:600,h,overridenSettings),{snap:snap,ascendant:ascendant,move:move,house:house}},Astrochart.AstrochartTheme=function(_svg,_settings){var _rotation={zodiac:105,houses:{1:0,2:30,3:60,4:90,5:120,6:150,7:180,8:210,9:240,10:270,11:300,12:330},"house-texts":{1:90,2:90,3:90,4:90,5:90,6:90,7:90,8:90,9:90,10:90,11:90,12:90},planets:{sun:0,moon:0,mercury:0,venus:0,mars:0,jupiter:0,saturn:0,uranus:0,neptune:0,pluto:0}},_houses={1:{text:"house-1-text"},2:{text:"house-2-text",id:"house-2"},3:{text:"house-3-text",id:"house-3"},4:{text:"house-4-text",id:"mc"},5:{text:"house-5-text",id:"house-5"},6:{text:"house-6-text",id:"house-6"},7:{text:"house-7-text"},8:{text:"house-8-text",id:"house-2"},9:{text:"house-9-text",id:"house-3"},10:{text:"house-10-text",id:"mc"},11:{text:"house-11-text",id:"house-5"},12:{text:"house-12-text",id:"house-6"}};Snap.load(_settings["sprites-base-url"]+"/zodiac.svg",function(svg){_svg.append(svg),orbit=_svg.createCircularOrbit(300,300,198),_svg.append(orbit),console.debug("Finished loading zodiac.svg.")}),Snap.load(_settings["sprites-base-url"]+"/things.svg",function(svg){function loadSpaceObject(svg,name,animationDelay){var object=svg.select("g#"+name);object||(object=svg.select("g#planet").clone(),object.attr({id:name})),_svg.append(object),object.orbit(orbit,0)}for(var planet in _rotation.planets)loadSpaceObject(svg,planet,1e4*Math.random()+3e3)});var _rotate=function(zodiac){var fixed=zodiac-_rotation.zodiac;return _round(fixed)},_round=function(number){return"number"!=typeof number&&console.warn("Invalid number",number,typeof number),number=Number(number.toFixed(5)),0>number&&(number+=360),number>=360&&(number-=360),number},_centerHouseText=function(house){"number"==typeof house&&(house=house.toString());var element=_svg.select("#"+_houses[house].text);if(element){var next=(parseInt(house)<12?parseInt(house)+1:1).toString();console.log("House",house,": ",_rotation.houses[house],"/",next,": ",_rotation.houses[next]);var center=180+(_round(_rotation.houses[next])+_round(_rotation.houses[house]))/2;"1"==next&&(center+=180);var rotation=_rotation["house-texts"][house]-center;console.log("Centering text for house",house,"to",center,"by",rotation,"was",_rotation["house-texts"][house]),_rotation["house-texts"][house]=center;var matrix=new Snap.Matrix;matrix.rotate(rotation,300,300),matrix.add(element.transform().localMatrix),element.transform(matrix)}else console.warn("No text for house",house)},invalidate=function(){for(var house in _houses)_centerHouseText(house)},ascendant=function(zodiac){var wheel=_svg.select("g#zodiac");if(!wheel)throw"not ready";var angleFrom=_rotation.zodiac-105,angleTo=zodiac-105;angleFrom!=angleTo&&(console.debug("Rotating zodiac to",zodiac),Snap.animate(angleFrom,angleTo,function(value){wheel.transform("r"+value+",300,300")},800),_rotation.zodiac=zodiac)},house=function(house,zodiac){if(void 0!==_houses[house].id){var element=_svg.select("#"+_houses[house].id);if(!element)throw"not ready";var fixed=_round(_rotate(zodiac)),rotation=_rotation.houses[house]-fixed;console.debug("Rotating house",house,"to",zodiac,"(",rotation,"rotation ).");var matrix=new Snap.Matrix;matrix.rotate(rotation,300,300),matrix.add(element.transform().localMatrix),element.transform(matrix);var next=(parseInt(house)>6?parseInt(house)-6:parseInt(house)+6).toString();_rotation.houses[house]=fixed,_rotation.houses[next]=_round(fixed+180),console.log("Moved house",house,"to",_rotation.houses[house]," / ",next,"to",_rotation.houses[next])}},astro=function(name,zodiac){var element=_svg.select("g#"+name);if(!element)throw"not ready";var angleFrom=_rotation.planets[name],angleTo=_rotate(zodiac);0>angleFrom&&(angleFrom=360+angleFrom),0>angleTo&&(angleTo=360+angleTo),console.debug("Moving",name,"from",angleFrom,"to",angleTo),Snap.animate(angleFrom,angleTo,function(value){element.orbit(orbit,value)},400),_rotation.planets[name]=angleTo};return{ascendant:ascendant,astro:astro,house:house,invalidate:invalidate}};