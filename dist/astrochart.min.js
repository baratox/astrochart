
/*
 * -------------------------------------------------------
 * Project: AstroChart
 * Version: 0.1.0
 *
 * Author:  KpriKornius
 * Site:     
 * Contact: 
 *
 *
 * Copyright (c) 2016 KpriKornius
 * -------------------------------------------------------
 */

Snap.plugin(function(Snap,Element,Paper){"use strict";Element.prototype.get_orbit=function(angle,radius,cx,cy){var x=cx+radius*Math.cos(Snap.rad(angle)),y=cy+radius*Math.sin(Snap.rad(angle));return{x:x,y:y}},Element.prototype.orbit=function(angle,radius,cx,cy){var point=this.get_orbit(angle,radius,cx,cy),matrix=new Snap.Matrix;matrix.translate(point.x,point.y),this.transformOriginal(matrix)}}),Snap.plugin(function(Snap,Element,Paper){"use strict";Element.prototype.transformOriginal=function(t,append){if("undefined"==typeof t)this.data("original-transform",this.transform().localMatrix);else{append="undefined"!=typeof append?append:!1;var original=null!=this.data("original-transform")?this.data("original-transform").clone():null;original?t instanceof Snap.Matrix?append?this.transform(original.add(t)):this.transform(t.add(original)):append?(this.transform(original),this.transform(t)):(this.transform(t),this.transform(original)):this.transform(t)}}}),window.Astrochart=function(w,h,overridenSettings){"use strict";function _Astrochart(w,h,overridenSettings){overridenSettings&&(settings=$.extend(settings,overridenSettings)),snap=Snap(w,h),snap.attr({viewBox:"0 0 600 600",height:"100%",width:"100%"}),theme=new Astrochart.AstrochartTheme(snap,settings)}function ascendant(degrees){return void 0!==degrees?(theme.ascendant(degrees),now.ascendant=degrees,this):now.ascendant}function move(planets,degrees){return iterateIfCollection(planets,degrees,_move)}function _move(planet,degrees){return void 0===now.planets[planet]?!1:void 0!==degrees?(theme.astro(planet,degrees),now.planets[planet]=degrees,this):now.planets[planet]}function house(houses,degrees){var result=iterateIfCollection(houses,degrees,_house);return theme.invalidate(),result}function _house(house,degrees){return house="number"!=typeof house?parseInt(house):house,void 0===now.houses[house]?!1:void 0!==degrees?(theme.house(house,degrees),now.houses[house]=degrees,this):now.houses[house]}function aspect(aspects){for(var i in aspects){var aspect=aspects[i];theme.aspect(aspect.a,aspect.b,aspect.value,aspect.classes)}}function iterateIfCollection(argument,parameter,callback){if("object"==typeof argument){for(var i in argument)callback(i,argument[i]);return this}return"string"==typeof argument||"number"==typeof argument?callback(argument,parameter):void 0}var snap,theme,settings={"sprites-base-url":"/dist/image"},now={ascendant:0,houses:{1:0,2:30,3:60,4:90,5:120,6:150,7:180,8:210,9:240,10:270,11:300,12:330},planets:{sun:0,moon:0,mercury:0,venus:0,mars:0,jupiter:0,saturn:0,uranus:0,neptune:0,pluto:0}};return _Astrochart(void 0!==w?w:600,h,overridenSettings),{snap:snap,theme:theme,ascendant:ascendant,move:move,house:house,aspect:aspect}},Astrochart.AstrochartTheme=function(_svg,_settings){var settings=jQuery.extend({"sprites-planet-size":108,center:{x:300,y:300},"astro-orbit":198,"aspect-orbit":164,"aspect-maximun-stroke":4,"visible-astros":["sun","moon","mercury","venus","mars","jupiter","saturn","uranus","neptune","pluto"],houses:{"house-1":{rotation:0,"text-rotation":90},"house-2":{rotation:30,"text-rotation":90},"house-3":{rotation:60,"text-rotation":90},"house-4":{rotation:90,"text-rotation":90},"house-5":{rotation:120,"text-rotation":90},"house-6":{rotation:150,"text-rotation":90},"house-7":{rotation:180,"text-rotation":90},"house-8":{rotation:210,"text-rotation":90},"house-9":{rotation:240,"text-rotation":90},"house-10":{rotation:270,"text-rotation":90},"house-11":{rotation:300,"text-rotation":90},"house-12":{rotation:330,"text-rotation":90}}},_settings),zodiac_rotation=105;Snap.load(settings["sprites-base-url"]+"/zodiac.svg",function(svg){_svg.append(svg);for(var house=1;12>=house;house++){var id="house-"+house,text=_svg.select("#"+id+"-text");text&&text.data("rotation",settings.houses[id]["text-rotation"]);var marker=_svg.select("#"+id);marker&&(marker.data("rotation",settings.houses[id].rotation),marker.data("text",text))}console.debug("Finished loading zodiac.svg.")}),Snap.load(settings["sprites-base-url"]+"/things.svg",function(svg){function loadSpaceObject(svg,name,animationDelay){console.log("Loading",name);var object=svg.select("g#"+name);object||(object=svg.select("g#planet").clone(),object.attr({id:name})),object.data("position",0),_svg.append(object);var scale=.37,half=scale*settings["sprites-planet-size"]/2,matrix=new Snap.Matrix;matrix.translate(-half,-half),matrix.scale(scale),object.transform(matrix),object.transformOriginal(),object.orbit(0,settings["astro-orbit"],settings.center.x,settings.center.y)}for(var i in settings["visible-astros"])loadSpaceObject(svg,settings["visible-astros"][i],1e4*Math.random()+3e3)});var _rotate=function(zodiac){var fixed=zodiac-zodiac_rotation;return _round(fixed)},_round=function(number){return"number"!=typeof number&&console.warn("Invalid number",number,typeof number),number=Number(number.toFixed(5)),0>number&&(number+=360),number>=360&&(number-=360),number},_centerHouseText=function(house_number){var text=house(house_number).data("text");if(text){var next=12>house_number?house_number+1:1,center=180+(_round(house(house_number).data("rotation"))+_round(house(next).data("rotation")))/2;12==house_number&&(center+=180);var rotation=text.data("rotation")-center;console.log("Centering text for house",house_number,"to",center,"by",rotation,"was",text.data("rotation")),text.data("rotation",center);var matrix=new Snap.Matrix;return matrix.rotate(rotation,300,300),matrix.add(text.transform().localMatrix),text.transform(matrix),text}throw"No text for house "+house_number},invalidate=function(){for(var house=1;12>=house;house++)_centerHouseText(house)},ascendant=function(zodiac){var wheel=_svg.select("g#zodiac");if(!wheel)throw"not ready";var angleFrom=zodiac_rotation-105,angleTo=zodiac-105;angleFrom!=angleTo&&(console.debug("Rotating zodiac to",zodiac),Snap.animate(angleFrom,angleTo,function(value){wheel.transform("r"+value+",300,300")},800),zodiac_rotation=zodiac)},house=function(house,zodiac){var element=_svg.select("#house-"+house);if(element){if(void 0===zodiac)return element;var fixed=_round(_rotate(zodiac)),rotation=element.data("rotation")-fixed;console.debug("Rotating house",house,"to",zodiac,"(",rotation,"rotation ).");var matrix=new Snap.Matrix;return matrix.rotate(rotation,300,300),matrix.add(element.transform().localMatrix),element.transform(matrix),element.data("rotation",fixed),element}throw"not ready"},astro=function(name,zodiac){var element=_svg.select("g#"+name);if(!element)throw"not ready";var angleFrom=element.data("position");angleTo=-(180+_rotate(zodiac)),0>angleFrom&&(angleFrom=360+angleFrom),angleTo<0&&(angleTo=360+angleTo),console.debug("Moving",name,"from",angleFrom,"to",angleTo),Snap.animate(angleFrom,angleTo,function(value){element.orbit(value,settings["astro-orbit"],settings.center.x,settings.center.y)},400),element.data("position",angleTo)},aspect=function(a,b,value,classes){if(settings["visible-astros"].indexOf(a)<0)throw a+" is unknown";if(settings["visible-astros"].indexOf(b)<0)throw b+" is unknown";var astro_a=_svg.select("#"+a),astro_b=_svg.select("#"+b),point_a=_svg.get_orbit(astro_a.data("position"),settings["aspect-orbit"],settings.center.x,settings.center.y),point_b=_svg.get_orbit(astro_b.data("position"),settings["aspect-orbit"],settings.center.x,settings.center.y),id=b>a?"aspect-"+a+"-"+b:"aspect-"+b+"-"+a,line=_svg.select("#"+id);return line?line.attr({"class":classes,x1:point_a.x,y1:point_a.y,x2:point_b.x,y2:point_b.y,strokeWidth:value*settings["aspect-maximun-stroke"]}):(line=_svg.line(point_a.x,point_a.y,point_b.x,point_b.y),line.attr({id:id,"class":classes}),line.attr({stroke:"#777",strokeWidth:value*settings["aspect-maximun-stroke"]}),_svg.add(line)),line};return{ascendant:ascendant,astro:astro,house:house,aspect:aspect,invalidate:invalidate}};